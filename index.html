<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheets Chatbox</title>
  <style>
    #chat-box {
      width: 100%;
      max-width: 600px;
      height: 400px;
      border: 1px solid #ccc;
      overflow-y: auto;
    }
    #chat-messages {
      padding: 10px;
    }
    #message-input {
      width: 80%;
    }
    #char-count {
      font-size: 12px;
      color: gray;
      display: block;
      margin-top: 5px;
    }
    #status-message {
      color: red;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="chat-box">
    <div id="chat-messages"></div>
  </div>
  <input type="text" id="username" placeholder="Username">
  <input type="text" id="message-input" maxlength="200" placeholder="Type your message...">
  <button id="send-btn">Send</button>
  <span id="char-count">200 characters remaining</span>
  <div id="status-message"></div>

  <script>
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-btn');
    const usernameInput = document.getElementById('username');
    const charCount = document.getElementById('char-count');
    const statusMessage = document.getElementById('status-message');

    const maxChars = 200; // Set the maximum allowed characters
    const webAppUrl = "https://script.google.com/macros/s/AKfycbwLUZmpGTv6WoFhI1SIHTbc7ueWRHJUQ9hko8ukAzW0CcIYMc4iPrwHnGKm7HRr6jus/exec"; // Replace with your Web App URL

    // Function to update the characters remaining counter
    function updateCharCount() {
      const remainingChars = maxChars - messageInput.value.length;
      charCount.textContent = `${remainingChars} characters remaining`;
    }

    // Reset input and character counter on page load
    window.addEventListener('load', () => {
      messageInput.value = ''; // Reset the message input field
      updateCharCount(); // Update character counter to reflect 200 characters remaining
    });

    // Add event listener for input changes to update character counter
    messageInput.addEventListener('input', updateCharCount);

    // Function to fetch messages from Google Sheets
    function fetchMessages() {
      fetch(`${webAppUrl}?action=fetch`)
        .then(response => response.json())
        .then(data => {
          chatMessages.innerHTML = "";
          data.forEach(message => {
            chatMessages.innerHTML += `<p><strong>${sanitizeHTML(message.username)}</strong>: ${sanitizeHTML(message.message)} <small>(${sanitizeHTML(message.timestamp)})</small></p>`;
          });
        })
        .catch(error => console.error('Error fetching messages:', error));
    }

    // Send message to Google Sheets
    sendButton.addEventListener('click', () => {
        const message = messageInput.value.trim();
        const username = usernameInput.value.trim() || "Anonymous";

        if (message.length === 0) {
            statusMessage.textContent = 'Message cannot be empty.';
            return;
        }

        if (message.length > maxChars) {
            // Instead of displaying a status message, just return without sending the message
            return;
        }

        fetch(`${webAppUrl}?action=send&username=${encodeURIComponent(username)}&message=${encodeURIComponent(message)}`)
            .then(response => response.text())
            .then(data => {
            if (data === "Message sent") {
                messageInput.value = '';
                updateCharCount();
                fetchMessages();
                statusMessage.textContent = '';
            } else {
                statusMessage.textContent = data;
            }
            })
            .catch(error => console.error('Error sending message:', error));
        });
    // Sanitize HTML to prevent XSS
    function sanitizeHTML(str) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    // Fetch messages every 5 seconds
    setInterval(fetchMessages, 5000);
    fetchMessages(); // Initial fetch
  </script>
</body>
</html>
